# Project Specification & Migration Plan: aiteam v2

## 1. PythonからNode.js (TypeScript) への移行計画

現在の `tmux` に依存したハック的なPythonスクリプトから、堅牢なプロセス間通信 (IPC/WebSocket) を用いたNode.jsベースのアプリケーションへ完全移行します。

### フェーズ分け
*   **Phase 1: 基盤構築**
    *   Node.js (TypeScript) プロジェクトの初期化
    *   ESLint, Prettier, Vitest などの開発環境整備
    *   Central Hub (WebSocket/JSON-RPC サーバー) のコア実装
*   **Phase 2: アダプター実装**
    *   Codex Adapter: `codex app-server` とのJSON-RPC連携
    *   Claude Adapter: `claude --print --input-format=stream-json --output-format=stream-json` のストリームパース処理
    *   Gemini Adapter: Gemini CLI の標準入出力ストリームラッパー
*   **Phase 3: CLIクライアント実装**
    *   ユーザー向けの新しいUIクライアント (ターミナルまたはウェブ)
    *   Hubサーバーとの通信プロトコル実装
*   **Phase 4: テストと安定化**
    *   E2EテストスイートのVitestへの移行
    *   Windows/macOS/Linuxでのクロスプラットフォーム動作確認

## 2. Node.js ベストプラクティス開発環境構築

モダンかつ堅牢な TypeScript 開発環境を構築します。

*   **パッケージマネージャ:** `pnpm` (または `npm` / `yarn` の固定) - 高速な依存解決のため。
*   **言語:** TypeScript (Strict mode)
*   **実行環境/ビルド:** `tsx` または `tsx` による高速な実行。ビルドツールには `tsup` や `esbuild` を採用しCLIバイナリを生成。
*   **リンター/フォーマッター:** ESLint (Flat Config) + Prettier。コミット時に `lint-staged` と `husky` で自動整形。
*   **テストフレームワーク:** Vitest。高速な実行と強力なモック機能、型安全なテストを活用。
*   **バリデーション:** Zod。外部プロセス（ClaudeやCodex）からのJSONストリーム入力に対する型安全なパースとバリデーションに使用。

## 3. Claude Code "Agent Teams" リサーチとユースケース

Web検索の結果、「Claude Code Agent Teams」は以下のような特徴を持つことがわかりました。
*   **概要:** "チームリード"（メインセッション）が"チームメイト"（サブエージェント）を起動し、複雑なタスクを並行処理する仕組み。
*   **連携方式:** サブエージェント同士が共有タスクリストとインボックス（メッセージング）を通じて直接会話・調整・反論を行う。
*   **メリット:** コンテキストの劣化を防ぎ、専門的なサブエージェントが並行して動くことで速度と品質が向上する。

### 一般的なユースケース
1.  **大規模リファクタリング:** 1人がコードを書き換え、もう1人が同時にテストを修正する。
2.  **フロントエンド＆バックエンド連携:** 1人がAPIエンドポイントを設計・実装し、もう1人が同時にそれに合わせたフロントエンドコンポーネントを作成する。
3.  **レビュー＆実装のループ:** 実装担当エージェントと、セキュリティ/パフォーマンス専門のレビュー担当エージェントがペアになり、品質を担保しながらコードを書く。

## 4. Gemini, Claude Code, Codex CLI 協業のAgent Teamsユースケース

各ツールの強みを活かした独自の Agent Teams コンセプトです。

*   **ユースケースA: 高速プロトタイピングとアーキテクチャ設計**
    *   **Gemini (リード/設計):** ユーザーと対話し、要求仕様からアーキテクチャ設計とタスク分割を行う。Web検索能力を活かして最新のライブラリ情報も収集。
    *   **Claude Code (コーディング/実装):** Geminiが分割したタスクに基づき、堅牢なTypeScriptのコードを実装する。
    *   **Codex CLI (環境構築/インフラ):** Dockerfileの生成、CI/CDの設定、シェルスクリプトによる自動環境構築を担う。
*   **ユースケースB: レガシーコードのマイグレーションとテスト拡充**
    *   **Claude Code (リード/解析):** 既存のレガシーコードを解析し、移行計画を策定。
    *   **Codex CLI (テスト生成):** 解析結果をもとに、既存の挙動を担保するための回帰テスト（Unit/E2E）を大量に自動生成する。
    *   **Gemini (コード変換):** テストが通ることを確認しながら、別の言語やフレームワークへコードを自動変換していく。
*   **ユースケースC: バグの自動調査と修正パッチ作成**
    *   **Gemini (ログ解析/トリアージ):** エラーログを読み解き、問題の切り分けと発生箇所のアタリをつける。
    *   **Codex CLI (OS/シェル操作):** サーバーやコンテナ内でコマンドを実行し、実際の状態（プロセス、ファイル）を調査して情報をGeminiに返す。
    *   **Claude Code (修正提案):** 原因が特定されたのち、修正コードとテストを実装する。

## 5. アーキテクチャ変更計画：スター型から「密結合型（ヘッドレス）」へ

従来の「全エージェントがターミナルのペイン（UI）を持ち、tmux越しに文字を送り合う（スター型）」アプローチを廃止します。

*   **新コンセプト:** ユーザーが直接対話するのは**1つのリードエージェントのUIのみ**。他のエージェントはバックグラウンドで「ヘッドレス（画面なし）」として起動し、プロセス間通信（JSONストリーム/WebSocket）で完全に密結合に連携します。
*   **メリット:**
    *   tmuxのような画面分割ツールが不要になり、Windows含む全OSでネイティブ動作。
    *   ユーザーは「エージェント同士の会話」という中間プロセスを見せられず、洗練された最終結果だけを受け取れる（必要に応じて進捗バー等で表現）。
    *   データ通信がプレーンテキストから構造化データ（JSON）になるため、情報の欠落やパースエラーが激減する。

## 6. 新アーキテクチャ用 E2E テストケース

Vitest を用いて、新アーキテクチャ（Node.js Hub + Headless Agents）のE2Eテストを実装します。

### テストケース1: ヘッドレスプロセスの起動と接続確認
*   **目的:** Central Hub が Codex, Claude, Gemini の各アダプタープロセスをヘッドレスで正常に起動し、通信チャネル（WebSocket等）が確立できるか。
*   **手順:**
    1. Hubサーバーをテストモードで起動。
    2. CodexとClaudeのモックプロセス（または実プロセスをテスト用の短いスクリプト付きで）を起動。
    3. `Hub.getConnectedAgents()` が `['codex', 'claude']` を返すことをアサート。

### テストケース2: リードからヘッドレスエージェントへのメッセージルーティング
*   **目的:** 密結合されたエージェント間で、Hubを介したメッセージパッシング（依頼と結果の受領）が正常に行われるか。
*   **手順:**
    1. リードエージェント（ダミーUI）から「Claudeに挨拶して」というコマンドをHubに送信。
    2. Hub がメッセージを JSON-RPC/Stream に変換して Claude アダプターへルーティング。
    3. Claude アダプターの `stdout` から返答のJSONストリームをキャプチャ。
    4. Hub が結果をリードエージェントへ正しく送り返すことをアサート。

### テストケース3: 共有タスク（インボックス）の並行処理
*   **目的:** Agent Teams の概念である、複数エージェントによる並列タスク実行と完了報告の統合をテストする。
*   **手順:**
    1. リードエージェントが「タスクAをCodexに、タスクBをGeminiに」依頼。
    2. Hubが両プロセスに対して非同期で同時にリクエストを発行。
    3. 両方のプロセスから非同期で「完了」イベント（JSONストリーム）が返ってくるのを待機（`Promise.all` 等）。
    4. リードエージェントのUIに、両方の完了結果がマージされて最終出力されることをアサート。

### テストケース4: プロセスクラッシュ時のリカバリとエラー伝搬
*   **目的:** ヘッドレスプロセスが予期せず終了した際の堅牢性を担保する。
*   **手順:**
    1. Codexアダプターのプロセスを `SIGKILL` 等で強制終了。
    2. Hub が終了イベントを検知し、リードエージェントに「Codexとの接続が切断されました」という構造化エラーイベントをルーティングできるかアサート。
    3. （オプション設定により）Hub がCodexプロセスを自動再起動できるかアサート。
